<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comic Craft AI - Kreator Komik Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- SISTEM TEMA VARIABEL --- */
        :root {
            --comic-border: 3px solid #000;
            --app-yellow: #facc15;
            --bg-app: #0f0f0f;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --input-bg: #2d2d2d;
            --input-border: #3f3f3f;
            --header-bg: rgba(15, 15, 15, 0.9);
            --shadow-color: #000000;
            --pattern-opacity: 0.15;
        }

        body.light-mode {
            --bg-app: #f4f4f5;
            --bg-card: #ffffff;
            --text-main: #18181b;
            --text-muted: #71717a;
            --input-bg: #ffffff;
            --input-border: #d4d4d8;
            --header-bg: rgba(255, 255, 255, 0.9);
            --shadow-color: #71717a;
            --pattern-opacity: 0.08;
        }
        
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Comic Neue', cursive;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
        }

        #dynamic-pattern-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            opacity: var(--pattern-opacity);
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 1px; }

        .app-card {
            background: var(--bg-card);
            border: var(--comic-border);
            border-radius: 1.5rem;
            box-shadow: 0 10px 0px var(--shadow-color);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-tap {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            border-radius: 1rem;
            cursor: pointer;
        }
        .btn-tap:active { transform: scale(0.92); box-shadow: 0 2px 0px #000 !important; }
        .btn-tap:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .comic-input {
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 1rem;
            padding: 1rem;
            width: 100%;
            color: var(--text-main);
            transition: border-color 0.2s;
        }
        .comic-input:focus { outline: none; border-color: var(--app-yellow); }

        .loader {
            border: 5px solid var(--input-border);
            border-top: 5px solid var(--app-yellow);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .section-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            max-width: 280px;
            height: 16px;
            background: #333;
            border: 3px solid #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 4px 4px 0px #000;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--app-yellow);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.4);
        }

        /* Render Zones */
        .hidden-render-container {
            position: fixed;
            left: -9999px;
            top: 0;
            z-index: -100;
            pointer-events: none;
        }
        
        #export-render-zone {
            width: 794px; 
            min-height: 1123px; 
            background: white;
            color: black;
            box-sizing: border-box;
            overflow: hidden;
        }

        #ig-story-zone {
            width: 1080px;
            height: 1920px;
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .sparkle-gradient {
            background: linear-gradient(90deg, #facc15, #fb923c);
            color: black;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen pb-40">

    <div id="dynamic-pattern-bg"></div>

    <header id="main-header" class="sticky top-0 z-40 py-4 px-6 bg-[var(--header-bg)] backdrop-blur-md border-b-2 border-[var(--input-border)] transition-all duration-300">
        <div class="flex justify-between items-center max-w-5xl mx-auto">
            <h1 class="comic-font text-3xl text-yellow-400 italic">COMIC CRAFT</h1>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" id="theme-toggle" class="btn-tap bg-[var(--input-bg)] p-2 border-2 border-[var(--input-border)] rounded-xl text-xl">üåô</button>
                <div class="hidden sm:block text-[10px] uppercase tracking-tighter bg-[var(--input-border)] px-2 py-1 rounded text-[var(--text-muted)] font-bold">Pro Creator AI</div>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-5 relative">
        
        <!-- Welcome Section -->
        <section id="welcome-section" class="text-center py-12 section-fade">
            <div class="app-card p-8 mb-6 border-yellow-400/30 text-center">
                <div class="text-6xl mb-4">üé®</div>
                <h2 class="comic-font text-4xl text-yellow-400 mb-2">KOMIK GENERATOR</h2>
                <p class="text-[var(--text-muted)] text-sm mb-8 italic">Bebaskan imajinasimu dengan asisten AI tercanggih.</p>
                <button onclick="showCreator()" class="btn-tap w-full bg-yellow-400 text-black py-5 comic-font text-2xl border-b-4 border-black shadow-[0_6px_0px_#854d0e]">
                    MULAI KARYA üöÄ
                </button>
            </div>
        </section>

        <!-- Form Creator -->
        <section id="creator-section" class="hidden">
            <div class="app-card p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="comic-font text-2xl text-yellow-400 italic">EDITOR CERITA</h2>
                    <button onclick="hideCreator()" class="text-[var(--text-muted)] font-bold text-xs uppercase">Batal</button>
                </div>

                <button onclick="generateFullIdea()" class="btn-tap w-full mb-8 py-4 sparkle-gradient border-2 border-black shadow-[4px_4px_0px_black] text-sm flex items-center justify-center gap-2">
                    üí° SAYA TIDAK PUNYA IDE! ‚ú®
                </button>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-black text-[var(--text-muted)] uppercase mb-2 tracking-widest">Nama Kreator</label>
                        <input type="text" id="creator-name" placeholder="Nama Anda..." class="comic-input">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-[var(--text-muted)] uppercase mb-2 tracking-widest">Judul Komik</label>
                        <div class="flex gap-2">
                            <input type="text" id="comic-title" placeholder="Judul keren..." class="comic-input">
                            <button onclick="suggestTitle()" class="btn-tap bg-[var(--input-border)] px-4 border-2 border-[var(--input-border)] text-lg" title="Saran Judul ‚ú®">‚ú®</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-[var(--text-muted)] uppercase mb-2 tracking-widest">Karakter Utama</label>
                        <div class="flex gap-2">
                            <input type="text" id="character-desc" placeholder="Rambut, pakaian, ciri khas..." class="comic-input text-sm">
                            <button onclick="analyzeCharacter()" class="btn-tap bg-[var(--input-border)] px-4 border-2 border-[var(--input-border)] text-[10px] font-bold uppercase" title="Detail Karakter AI ‚ú®">BEDAH ‚ú®</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-[var(--text-muted)] uppercase mb-2 tracking-widest">Genre</label>
                            <select id="comic-genre" class="comic-input text-sm appearance-none">
                                <option value="Action">Action</option>
                                <option value="Adventure">Adventure</option>
                                <option value="Fantasy">Fantasy</option>
                                <option value="Horror">Horror</option>
                                <option value="Romance">Romance</option>
                                <option value="Sci-Fi">Sci-Fi</option>
                                <option value="Comedy">Comedy</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-black text-[var(--text-muted)] uppercase mb-2 tracking-widest">Style</label>
                            <select id="comic-style" class="comic-input text-sm appearance-none">
                                <option value="Vibrant Anime Art">Anime</option>
                                <option value="Detailed Manga Ink">Manga</option>
                                <option value="Modern Webtoon Art">Webtoon</option>
                                <option value="Realistic Cinematic Painting">Realistic</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-black text-[var(--text-muted)] uppercase tracking-widest">Panel Awal</label>
                            <span class="text-yellow-400 font-bold" id="page-val">3 Panel</span>
                        </div>
                        <input type="range" id="comic-pages" min="1" max="15" value="3" class="w-full h-2 bg-[var(--input-border)] rounded-lg appearance-none accent-yellow-400" oninput="document.getElementById('page-val').innerText = this.value + ' Panel'">
                    </div>

                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-black text-[var(--text-muted)] uppercase tracking-widest">Plot Cerita</label>
                            <div class="flex gap-2">
                                <button onclick="expandStory()" class="text-[10px] font-bold text-yellow-500 uppercase underline italic">PERLUAS ‚ú®</button>
                                <button onclick="generatePlotTwist()" class="text-[10px] font-bold text-orange-500 uppercase underline italic">TWIST ‚ú®</button>
                            </div>
                        </div>
                        <textarea id="comic-desc" rows="4" placeholder="Ceritakan alur awalnya di sini..." class="comic-input text-sm"></textarea>
                    </div>
                </div>

                <button onclick="generateComic()" id="main-gen-btn" class="btn-tap w-full mt-10 bg-yellow-400 text-black py-5 comic-font text-2xl border-b-4 border-black shadow-[0_6px_0px_#854d0e]">
                    BANGKITKAN! ‚ö°
                </button>
            </div>
        </section>

        <!-- Preview Section -->
        <section id="preview-section" class="hidden section-fade">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="comic-font text-2xl text-yellow-400 uppercase truncate max-w-[140px] sm:max-w-[200px]" id="display-title">JUDUL</h2>
                    <p class="text-[10px] text-[var(--text-muted)] font-bold uppercase tracking-widest" id="display-creator">Oleh: Nama Anda</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="enterReadingMode()" class="btn-tap bg-[var(--input-border)] text-yellow-400 px-4 py-2 border-2 border-yellow-400/30 rounded-xl font-bold text-xs uppercase shadow-lg">üìñ BACA</button>
                    <button onclick="openResetModal()" class="btn-tap bg-[var(--input-border)] text-[var(--text-muted)] p-2 border-2 border-[var(--input-border)] rounded-xl">‚úñ</button>
                </div>
            </div>

            <div id="capture-container" class="app-card overflow-hidden mb-6 bg-white border-4 border-black">
                <div class="relative min-h-[400px]">
                    <div id="cover-label" class="absolute top-4 left-4 bg-black text-white px-3 py-1 font-black text-[10px] z-10 rounded-full uppercase">Sampul</div>
                    <img id="current-panel-img" src="" alt="Comic" class="panel-transition w-full h-auto object-contain bg-zinc-200 min-h-[300px]" crossorigin="anonymous">
                </div>
                
                <div id="caption-wrapper" class="p-5 border-t-2 border-black bg-yellow-50 text-black">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-black text-zinc-400 uppercase tracking-widest italic">Narasi Panel</span>
                        <div class="flex gap-2">
                            <button onclick="polishDialogue()" class="text-[10px] font-bold text-blue-600 uppercase italic">POLES ‚ú®</button>
                            <button onclick="translatePanel()" class="text-[10px] font-bold text-purple-600 uppercase italic">TRANS ‚ú®</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <textarea id="panel-caption" class="w-full p-3 bg-white border-2 border-black rounded-xl font-bold italic text-sm leading-tight" rows="3"></textarea>
                        <button onclick="playTTS()" id="tts-btn" class="btn-tap bg-black text-white px-4 rounded-xl flex items-center justify-center">üîä</button>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-8">
                <button onclick="prevPage()" class="btn-tap bg-black text-white p-4 shadow-xl rounded-2xl">‚Üê</button>
                <button onclick="addExtraPanel()" id="add-panel-btn" class="btn-tap bg-blue-600 text-white px-6 py-4 border-2 border-black shadow-[4px_4px_0px_black] font-black text-xs uppercase flex items-center gap-2">
                    + PANEL ‚ú®
                </button>
                <button onclick="nextPage()" class="btn-tap bg-black text-white p-4 shadow-xl rounded-2xl">‚Üí</button>
            </div>

            <div class="text-center mb-8">
                <div class="comic-font text-xl text-[var(--text-muted)] italic" id="page-indicator">HALAMAN 1</div>
            </div>

            <div class="app-card bg-[var(--input-bg)] border-dashed border-[var(--input-border)] p-5 mb-40 text-center">
                <h3 class="text-xs font-black text-[var(--text-muted)] uppercase tracking-widest mb-4">Export Tools</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="exportImage('png')" class="btn-tap bg-zinc-800 text-white text-[10px] py-4 border border-zinc-700 font-bold uppercase shadow-sm">PNG</button>
                    <button onclick="exportImage('jpg')" class="btn-tap bg-zinc-800 text-white text-[10px] py-4 border border-zinc-700 font-bold uppercase shadow-sm">JPG</button>
                </div>
                <button onclick="exportIGStory()" class="btn-tap w-full bg-gradient-to-r from-pink-600 to-orange-500 text-white text-xs py-5 font-black uppercase shadow-lg border-2 border-black">
                    EXPORT STORY üì∏
                </button>
            </div>

            <div class="fixed bottom-0 left-0 right-0 p-4 bg-[var(--header-bg)] backdrop-blur-xl border-t border-[var(--input-border)] z-50 flex gap-3 max-w-xl mx-auto shadow-2xl">
                <button onclick="downloadPDF()" class="btn-tap flex-1 bg-yellow-400 text-black font-black py-5 text-xl border-2 border-black shadow-[0_4px_0px_#000] comic-font italic uppercase">UNDUH PDF PRO üìö</button>
            </div>
        </section>

        <!-- Loading State -->
        <div id="loading-state" class="hidden fixed inset-0 bg-[var(--bg-app)] opacity-98 z-[100] flex flex-col items-center justify-center p-10 text-center">
            <div class="loader mb-10"></div>
            <h2 class="comic-font text-4xl text-yellow-400 mb-2 italic uppercase text-center">PROSES AI... ‚ú®</h2>
            <div class="progress-bar-container mb-2 mx-auto">
                <div id="progress-bar-fill" class="progress-bar-fill"></div>
            </div>
            <p id="progress-percent" class="text-yellow-400 font-black text-xl mb-4 italic text-center">0%</p>
            <p id="loading-msg" class="text-[var(--text-muted)] text-[10px] font-bold uppercase tracking-[0.3em] max-w-xs leading-relaxed text-center">Menyiapkan kanvas imajinasi Anda</p>
        </div>

        <!-- Custom Reset Modal -->
        <div id="reset-modal" class="hidden fixed inset-0 bg-black/90 z-[110] flex items-center justify-center p-8">
            <div class="app-card bg-white p-8 text-center max-w-xs border-4 border-black text-black">
                <h3 class="comic-font text-3xl mb-2 text-center">HAPUS KARYA?</h3>
                <p class="text-zinc-600 text-sm mb-8 font-bold text-center">Progress akan hilang selamanya.</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeResetModal()" class="btn-tap py-3 border-2 border-zinc-300 font-bold text-black text-sm uppercase">Batal</button>
                    <button onclick="executeReset()" class="btn-tap py-3 bg-red-600 text-white font-bold text-sm border-2 border-black uppercase">YA, HAPUS</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Reading Mode Overlay -->
    <div id="reading-mode-overlay" class="hidden fixed inset-0 bg-black z-[200] overflow-y-auto">
        <button onclick="exitReadingMode()" class="fixed top-6 right-6 z-[210] bg-yellow-400 text-black w-12 h-12 rounded-full flex items-center justify-center border-4 border-black btn-tap font-black text-xl shadow-2xl">√ó</button>
        <div id="reading-content-list" class="flex flex-col items-center bg-black min-h-screen"></div>
    </div>

    <!-- Hidden Rendering Zones -->
    <div class="hidden-render-container">
        <div id="export-render-zone"></div>
        <div id="ig-story-zone"></div>
    </div>

    <script>
        const apiKey = "";
        let comicData = { title: "", creator: "", genre: "", style: "", charDesc: "", coverUrl: "", panels: [], currentIndex: -1 };

        // --- SISTEM TEKNIS ---
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const btn = document.getElementById('theme-toggle');
            if(btn) btn.innerText = document.body.classList.contains('light-mode') ? "‚òÄÔ∏è" : "üåô";
        }

        function updateProgress(percent, message) {
            const fill = document.getElementById('progress-bar-fill');
            const text = document.getElementById('progress-percent');
            const msg = document.getElementById('loading-msg');
            if (fill) fill.style.width = `${percent}%`;
            if (text) text.innerText = `${percent}%`;
            if (msg && message) msg.innerText = message;
        }

        async function apiRequest(payload, isImage = false, customModel = null) {
            const model = customModel || (isImage ? 'imagen-4.0-generate-001' : 'gemini-2.5-flash-preview-09-2025');
            const endpoint = isImage ? 'predict' : 'generateContent';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:${endpoint}?key=${apiKey}`;
            
            const delays = [1000, 2000, 4000, 8000];
            for (let i = 0; i < 4; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) return await response.json();
                } catch (e) {}
                await new Promise(r => setTimeout(r, delays[i]));
            }
            throw new Error("API Gemini sibuk. Silakan coba lagi.");
        }

        function cleanJSON(text) {
            let clean = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const start = clean.indexOf('{');
            const end = clean.lastIndexOf('}');
            if (start !== -1 && end !== -1) return clean.substring(start, end + 1);
            return clean;
        }

        async function fetchImage(prompt) {
            const cleanPrompt = `${comicData.style}, ${comicData.genre} theme. ${prompt}. Character: ${comicData.charDesc}. High-end comic artwork, professional coloring. NO text labels. Strictly IMAGE ONLY.`;
            const payload = { instances: { prompt: cleanPrompt }, parameters: { sampleCount: 1 } };
            const res = await apiRequest(payload, true);
            if (!res.predictions?.[0]?.bytesBase64Encoded) throw new Error("Gagal generate gambar");
            return `data:image/png;base64,${res.predictions[0].bytesBase64Encoded}`;
        }

        // --- GEMINI ACTIONS ---
        async function generateFullIdea() {
            const genre = document.getElementById('comic-genre').value;
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Mencari inspirasi... ‚ú®");
            loading.classList.remove('hidden');
            try {
                updateProgress(50, "Gemini sedang merangkai cerita unik... üí°");
                const res = await apiRequest({
                    contents: [{ parts: [{ text: `Buat ide komik genre ${genre}. Berikan judul kreatif, deskripsi karakter ikonik, dan plot seru dalam Bahasa Indonesia.` }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT", properties: { title: { type: "STRING" }, character: { type: "STRING" }, plot: { type: "STRING" } }, required: ["title", "character", "plot"]
                        }
                    }
                });
                const data = JSON.parse(res.candidates[0].content.parts[0].text);
                document.getElementById('comic-title').value = data.title;
                document.getElementById('character-desc').value = data.character;
                document.getElementById('comic-desc').value = data.plot;
                updateProgress(100, "Ide siap! üöÄ");
                setTimeout(() => loading.classList.add('hidden'), 500);
            } catch (e) { alert("Gagal mengambil ide."); loading.classList.add('hidden'); }
        }

        async function analyzeCharacter() {
            const desc = document.getElementById('character-desc').value;
            if (!desc) return alert("Isi deskripsi karakter dulu!");
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Membedah karakter... ‚ú®");
            loading.classList.remove('hidden');
            try {
                updateProgress(60, "Gemini menyarankan detail ikonik... üé®");
                const res = await apiRequest({ contents: [{ parts: [{ text: `Sebagai desainer karakter komik, berikan 2 detail visual unik untuk karakter "${desc}" agar terlihat profesional (misal: jubah robek, tato neon, senjata unik). Sangat singkat.` }] }] });
                const advice = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (advice) document.getElementById('character-desc').value += " (Detail: " + advice.trim() + ")";
                updateProgress(100, "Visual ditingkatkan!");
            } catch(e) { alert("Gagal membedah."); }
            finally { setTimeout(() => loading.classList.add('hidden'), 500); }
        }

        async function polishDialogue() {
            const current = document.getElementById('panel-caption').value;
            if (!current) return;
            const btn = event.currentTarget;
            btn.innerText = "‚è≥";
            try {
                const res = await apiRequest({ contents: [{ parts: [{ text: `Tulis ulang narasi komik ini agar lebih dramatis, puitis, dan profesional dalam Bahasa Indonesia: "${current}"` }] }] });
                const polished = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (polished) {
                    document.getElementById('panel-caption').value = polished.trim();
                    if (comicData.currentIndex >= 0) comicData.panels[comicData.currentIndex].caption = polished.trim();
                }
            } catch(e) {}
            finally { btn.innerText = "POLES ‚ú®"; }
        }

        async function translatePanel() {
            const current = document.getElementById('panel-caption').value;
            if (!current) return;
            const btn = event.currentTarget;
            btn.innerText = "‚è≥";
            try {
                const res = await apiRequest({ contents: [{ parts: [{ text: `Terjemahkan narasi komik ini ke Bahasa Inggris secara profesional: "${current}"` }] }] });
                const trans = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (trans) {
                    document.getElementById('panel-caption').value = trans.trim();
                    if (comicData.currentIndex >= 0) comicData.panels[comicData.currentIndex].caption = trans.trim();
                }
            } catch(e) {}
            finally { btn.innerText = "TRANS ‚ú®"; }
        }

        async function expandStory() {
            const current = document.getElementById('comic-desc').value;
            if (!current) return alert("Isi plot awal!");
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Memperluas plot... ‚ú®");
            loading.classList.remove('hidden');
            try {
                updateProgress(60, "Gemini menulis kejutan plot... üìñ");
                const res = await apiRequest({ contents: [{ parts: [{ text: `Perluas plot komik ini secara dramatis dalam 2 kalimat saja: "${current}"` }] }] });
                const expanded = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (expanded) document.getElementById('comic-desc').value = expanded.trim();
                updateProgress(100, "Plot diperluas!");
            } finally { setTimeout(() => loading.classList.add('hidden'), 500); }
        }

        async function generatePlotTwist() {
            const current = document.getElementById('comic-desc').value;
            if (!current) return;
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Mencari twist gila... ‚ú®");
            loading.classList.remove('hidden');
            try {
                const res = await apiRequest({ contents: [{ parts: [{ text: `Berikan satu plot twist mengejutkan dan singkat untuk cerita ini: "${current}"` }] }] });
                const twist = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (twist) document.getElementById('comic-desc').value += " Twist: " + twist.trim();
            } finally { loading.classList.add('hidden'); }
        }

        async function generateComic() {
            const title = document.getElementById('comic-title').value || "Komik Tanpa Judul";
            const creator = document.getElementById('creator-name').value || "Anonim";
            const genre = document.getElementById('comic-genre').value;
            const style = document.getElementById('comic-style').value;
            const charDesc = document.getElementById('character-desc').value;
            const pages = parseInt(document.getElementById('comic-pages').value);
            const desc = document.getElementById('comic-desc').value;

            if (!desc) return alert("Cerita tidak boleh kosong!");
            comicData = { title, creator, genre, style, charDesc, panels: [], currentIndex: -1 };
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Inisialisasi... ‚ú®");
            loading.classList.remove('hidden');
            
            try {
                updateProgress(10, "Melukis Sampul Depan... üé®");
                comicData.coverUrl = await fetchImage(`Official comic book cover art for title "${title}"`);

                updateProgress(25, "Menyusun Naskah Gemini... üìñ");
                const scriptRes = await apiRequest({
                    contents: [{ parts: [{ text: `Buat naskah komik ${pages} panel: Judul "${title}", Genre ${genre}, Karakter: ${charDesc}. Plot: ${desc}. Narasi panel dalam Bahasa Indonesia.` }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT", properties: { panels: { type: "ARRAY", items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, caption: { type: "STRING" } }, required: ["prompt", "caption"] } } }, required: ["panels"]
                        }
                    }
                });
                
                const script = JSON.parse(scriptRes.candidates[0].content.parts[0].text);
                for (let i = 0; i < script.panels.length; i++) {
                    let p = 25 + Math.floor(((i + 1) / pages) * 75);
                    updateProgress(p, `Melukis Panel ${i+1}/${pages}... üñåÔ∏è`);
                    const imgUrl = await fetchImage(script.panels[i].prompt);
                    comicData.panels.push({ imageUrl: imgUrl, caption: script.panels[i].caption });
                }
                
                renderPreview();
            } catch (err) { alert("Gagal generate komik. Coba kurangi jumlah panel."); }
            finally { loading.classList.add('hidden'); }
        }

        async function addExtraPanel() {
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Menganalisis kelanjutan... üìñ");
            loading.classList.remove('hidden');
            const story = comicData.panels.map(p => p.caption).join(". ");
            try {
                updateProgress(40, "Merangkai adegan baru... ‚ú®");
                const res = await apiRequest({
                    contents: [{ parts: [{ text: `Lanjutkan cerita ini dengan 1 panel berikutnya: "${story}". Berikan narasi Indonesia.` }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT", properties: { prompt: { type: "STRING" }, caption: { type: "STRING" } }, required: ["prompt", "caption"]
                        }
                    }
                });
                const data = JSON.parse(res.candidates[0].content.parts[0].text);
                updateProgress(70, "Melukis panel baru... üñåÔ∏è");
                const imgUrl = await fetchImage(data.prompt);
                comicData.panels.push({ imageUrl: imgUrl, caption: data.caption });
                comicData.currentIndex = comicData.panels.length - 1;
                updatePanelDisplay();
                updateProgress(100, "Siap! üöÄ");
            } catch (err) { alert("Gagal menambah panel."); }
            finally { setTimeout(() => loading.classList.add('hidden'), 500); }
        }

        // --- CORE UI & SYSTEM ---
        function enterReadingMode() {
            const overlay = document.getElementById('reading-mode-overlay');
            const content = document.getElementById('reading-content-list');
            const header = document.getElementById('main-header');
            if (!overlay || !content) return;
            content.innerHTML = ""; 
            overlay.classList.remove('hidden');
            document.body.style.overflow = "hidden"; 
            if (header) header.style.opacity = "0";

            const titleDiv = document.createElement('div');
            titleDiv.className = "py-32 text-center px-6 w-full max-w-2xl bg-zinc-950";
            titleDiv.innerHTML = `<h2 class="comic-font text-7xl text-yellow-400 mb-4 uppercase italic leading-none">${comicData.title}</h2><p class="text-zinc-600 font-bold uppercase tracking-widest text-xs">By ${comicData.creator}</p>`;
            content.appendChild(titleDiv);

            if (comicData.coverUrl) {
                const coverImg = document.createElement('img');
                coverImg.src = comicData.coverUrl;
                coverImg.className = "w-full max-w-2xl border-b-8 border-black";
                content.appendChild(coverImg);
            }

            comicData.panels.forEach((p) => {
                const div = document.createElement('div');
                div.className = "w-full max-w-2xl flex flex-col items-center bg-zinc-900 mb-2";
                div.innerHTML = `<img src="${p.imageUrl}" class="w-full" crossorigin="anonymous"><div class="p-12 text-center text-zinc-100 italic text-2xl font-bold border-y-8 border-black leading-relaxed bg-zinc-900 w-full">"${p.caption}"</div>`;
                content.appendChild(div);
            });

            const endDiv = document.createElement('div');
            endDiv.className = "py-40 text-center flex flex-col items-center px-6 w-full bg-black";
            endDiv.innerHTML = `<h3 class="comic-font text-9xl text-yellow-400 mb-8 italic">TAMAT</h3><div class="bg-white text-black p-10 border-4 border-black shadow-[10px_10px_0_#facc15] mb-12 max-w-xs text-center"><p class="text-3xl font-black mb-1">Thanks for reading! üé®</p><p class="opacity-70 font-bold uppercase text-[10px]">by ${comicData.creator}</p></div><button onclick="exitReadingMode()" class="bg-zinc-800 text-white px-12 py-4 rounded-full font-bold border-2 border-zinc-700 btn-tap">Editor</button>`;
            content.appendChild(endDiv);
            overlay.scrollTop = 0;
        }

        function exitReadingMode() {
            document.getElementById('reading-mode-overlay').classList.add('hidden');
            document.body.style.overflow = "auto";
            document.getElementById('main-header').style.opacity = "1";
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const loading = document.getElementById('loading-state');
            const zone = document.getElementById('export-render-zone');
            updateProgress(0, "Merakit PDF Pro... üìö");
            loading.classList.remove('hidden');
            
            try {
                // 1. PREMIUM COVER
                updateProgress(15, "Mengekspor Sampul Premium... üìñ");
                zone.innerHTML = `<div style="height:1123px; padding:60px; display:flex; flex-direction:column; justify-content:space-between; text-align:center; font-family:'Comic Neue', sans-serif; border:20px solid black; background:white;"><div style="text-align:center; margin-top:20px;"><h1 style="font-family:'Bangers', cursive; font-size:72px; line-height:0.9; color:black; margin:0; text-transform:uppercase;">${comicData.title}</h1><div style="display:inline-block; background:black; color:white; padding:5px 20px; font-weight:bold; font-size:14px; margin-top:15px;">EDISI KOLEKTOR AI</div></div><div style="flex-grow:1; display:flex; align-items:center; justify-content:center; padding:40px 0;"><img src="${comicData.coverUrl}" style="max-width:100%; border:12px solid black; box-shadow:20px 20px 0_rgba(0,0,0,0.1);" crossorigin="anonymous"></div><div style="margin-bottom:20px;"><p style="font-size:22px; font-weight:bold; margin:0; color:#444; letter-spacing:2px;">GENRE: ${comicData.genre.toUpperCase()}</p><div style="height:5px; background:black; width:80px; margin:15px auto;"></div><p style="font-family:'Bangers', cursive; font-size:38px; margin:10px 0 0 0; color:black;">KARYA: ${comicData.creator.toUpperCase()}</p></div></div>`;
                await new Promise(r => setTimeout(r, 1200));
                let canvas = await html2canvas(zone, { scale: 1.5, useCORS: true });
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, 210, 297);
                
                // 2. PANELS WITH SMART SCALING
                for (let i = 0; i < comicData.panels.length; i++) {
                    let pVal = 15 + Math.floor(((i + 1) / comicData.panels.length) * 75);
                    updateProgress(pVal, `Memproses Halaman ${i+1}/${comicData.panels.length}... üìö`);
                    pdf.addPage();
                    const p = comicData.panels[i];
                    const capLength = p.caption.length;
                    let fontSize = capLength > 400 ? "18px" : capLength > 250 ? "22px" : capLength > 150 ? "28px" : "34px";

                    zone.innerHTML = `<div style="height:1123px; padding:40px; display:flex; flex-direction:column; font-family:'Comic Neue', sans-serif; background:white;"><div style="flex-grow:1; min-height:0; display:flex; align-items:center; justify-content:center; background:#f8f8f8; border:4px solid black;"><img src="${p.imageUrl}" style="max-width:100%; max-height:100%; object-fit:contain; border:6px solid black;" crossorigin="anonymous"></div><div style="background:#fff9db; border:6px solid black; padding:30px; text-align:center; font-size:${fontSize}; font-weight:bold; font-style:italic; margin-top:30px; border-radius:8px; line-height:1.3; color:black; box-shadow:10px 10px 0_rgba(0,0,0,0.05); width:100%; box-sizing:border-box; overflow-wrap:break-word;">"${p.caption}"</div><div style="text-align:right; margin-top:15px; font-weight:bold; font-size:16px; color:#aaa; text-transform:uppercase; letter-spacing:2px;">HALAMAN ${i + 1}</div></div>`;
                    await new Promise(r => setTimeout(r, 800));
                    canvas = await html2canvas(zone, { scale: 1.5, useCORS: true });
                    pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, 210, 297);
                }

                // 3. FINAL PAGE
                updateProgress(95, "Sentuhan Akhir... ‚ú®");
                pdf.addPage();
                zone.innerHTML = `<div style="height:1123px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-family:'Comic Neue', sans-serif; border:25px solid black; background:white; padding:60px;"><h1 style="font-family:'Bangers', cursive; font-size:110px; color:#facc15; -webkit-text-stroke:3px black; margin:0; text-transform:uppercase;">TAMAT</h1><div style="margin:40px 0; transform:rotate(-1deg);"><div style="background:black; color:white; padding:40px 60px; border:5px solid #facc15; box-shadow:15px 15px 0_black;"><p style="font-size:42px; font-weight:bold; margin:0; line-height:1;">Thanks for reading! üé®</p><p style="font-size:18px; margin-top:15px; opacity:0.8; font-weight:bold; text-transform:uppercase; letter-spacing:2px;">ORIGINAL WORK BY ${comicData.creator}</p></div></div><p style="margin-top:100px; color:#bbb; font-size:14px; font-weight:bold; letter-spacing:6px; text-transform:uppercase;">CREATED WITH COMIC CRAFT AI</p></div>`;
                await new Promise(r => setTimeout(r, 900));
                canvas = await html2canvas(zone, { scale: 1.5, useCORS: true });
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, 210, 297);

                const blob = pdf.output('blob');
                downloadBlob(blob, `${comicData.title.replace(/\s+/g, '_')}_Final.pdf`);
            } catch (e) { alert("Gagal PDF."); }
            finally { setTimeout(() => loading.classList.add('hidden'), 500); }
        }

        async function exportImage(format) {
            const container = document.getElementById('capture-container');
            const loading = document.getElementById('loading-state');
            updateProgress(0, "Menyiapkan ekspor... üì∏");
            loading.classList.remove('hidden');
            try {
                updateProgress(50, "Mengekspor halaman... üñºÔ∏è");
                const canvas = await html2canvas(container, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                canvas.toBlob((blob) => {
                    downloadBlob(blob, `${comicData.title.replace(/\s+/g, '_')}_Panel.${format}`);
                }, `image/${format === 'jpg' ? 'jpeg' : 'png'}`);
                updateProgress(100, "Berhasil! üéâ");
            } catch (e) { alert("Gagal."); }
            finally { setTimeout(() => loading.classList.add('hidden'), 500); }
        }

        async function exportIGStory() {
            const loading = document.getElementById('loading-state');
            const zone = document.getElementById('ig-story-zone');
            updateProgress(0, "Render Story... üì±");
            loading.classList.remove('hidden');
            const isCover = comicData.currentIndex === -1;
            zone.innerHTML = `<div style="text-align:center; padding: 60px;"><h1 style="font-family:'Bangers', cursive; font-size:100px; color:#facc15; margin-bottom:40px;">${comicData.title}</h1><img src="${isCover ? comicData.coverUrl : comicData.panels[comicData.currentIndex].imageUrl}" style="width:960px; border:20px solid white; box-shadow:0 30px 60px rgba(0,0,0,0.5);" crossorigin="anonymous"><p style="font-size:40px; margin-top:50px; font-weight:bold; color:white;">BY ${comicData.creator.toUpperCase()}</p></div>`;
            try {
                await new Promise(r => setTimeout(r, 1200));
                const canvas = await html2canvas(zone, { scale: 1, useCORS: true });
                canvas.toBlob((blob) => {
                    downloadBlob(blob, `Story.png`);
                }, 'image/png');
                updateProgress(100, "Story siap! üì∏");
            } catch (e) { alert("Gagal Story."); }
            finally { setTimeout(() => loading.classList.add('hidden'), 500); }
        }

        function downloadBlob(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
            setTimeout(() => window.URL.revokeObjectURL(url), 100);
        }

        async function playTTS() {
            const text = document.getElementById('panel-caption').value;
            if (!text) return;
            const btn = document.getElementById('tts-btn');
            btn.innerText = "‚è≥";
            try {
                const res = await apiRequest({ contents: [{ parts: [{ text: `Narator komik Indonesia: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } }, false, "gemini-2.5-flash-preview-tts");
                const pcmData = res.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (pcmData) {
                    const head = new ArrayBuffer(44); const v = new DataView(head);
                    const u8 = Uint8Array.from(atob(pcmData), c => c.charCodeAt(0));
                    v.setUint32(0, 0x52494646, false); v.setUint32(4, 36+u8.length, true); v.setUint32(8, 0x57415645, false); v.setUint32(12, 0x666d7420, false); v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true); v.setUint32(24, 24000, true); v.setUint32(28, 48000, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true); v.setUint32(36, 0x64617461, false); v.setUint32(40, u8.length, true);
                    const audio = new Audio(URL.createObjectURL(new Blob([head, u8], {type:'audio/wav'})));
                    audio.play(); audio.onended = () => btn.innerText = "üîä";
                }
            } catch (e) { btn.innerText = "üîä"; }
        }

        function showCreator() { document.getElementById('creator-section').classList.remove('hidden'); document.getElementById('welcome-section').classList.add('hidden'); window.scrollTo(0,0); }
        function hideCreator() { document.getElementById('creator-section').classList.add('hidden'); document.getElementById('welcome-section').classList.remove('hidden'); }
        function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
        function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }
        function executeReset() { comicData = { title: "", panels: [], currentIndex: -1 }; closeResetModal(); document.getElementById('preview-section').classList.add('hidden'); document.getElementById('welcome-section').classList.remove('hidden'); }
        function nextPage() { if (comicData.currentIndex < comicData.panels.length - 1) { comicData.currentIndex++; updatePanelDisplay(); } }
        function prevPage() { if (comicData.currentIndex > -1) { comicData.currentIndex--; updatePanelDisplay(); } }

        window.addEventListener('DOMContentLoaded', () => {
            const viewer = document.getElementById('capture-container');
            if (viewer) {
                let startX = 0;
                viewer.addEventListener('touchstart', e => startX = e.touches[0].clientX, { passive: true });
                viewer.addEventListener('touchend', e => { const diff = startX - e.changedTouches[0].clientX; if(Math.abs(diff) > 70) diff > 0 ? nextPage() : prevPage(); }, { passive: true });
            }
        });
    </script>
</body>
</html>
